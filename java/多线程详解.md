# å¤šçº¿ç¨‹è¯¦è§£

---

## çº¿ç¨‹ç®€ä»‹

### ç¨‹åºã€è¿›ç¨‹ã€çº¿ç¨‹

åœ¨æ“ä½œç³»ç»Ÿä¸­è¿è¡Œçš„ç¨‹åºå°±æ˜¯è¿›ç¨‹ã€‚

**ä¸€ä¸ªè¿›ç¨‹å¯ä»¥æœ‰å¤šä¸ªçº¿ç¨‹**ï¼Œå¦‚è§†é¢‘ä¸­åŒæ—¶å¬å£°éŸ³ï¼Œçœ‹å›¾åƒï¼Œçœ‹å¼¹å¹•ï¼Œç­‰ç­‰ã€‚

### Process ä¸ Thread

- è¯´èµ·è¿›ç¨‹ï¼Œå°±ä¸å¾—ä¸è¯´ä¸‹**ç¨‹åº**ã€‚ç¨‹åºæ˜¯æŒ‡ä»¤å’Œæ•°æ®çš„æœ‰åºé›†åˆï¼Œå…¶æœ¬èº«æ²¡æœ‰ä»»ä½•è¿è¡Œçš„å«ä¹‰ï¼Œæ˜¯ä¸€ä¸ªé™æ€çš„æ¦‚å¿µã€‚
- è€Œ**è¿›ç¨‹**åˆ™æ˜¯æ‰§è¡Œç¨‹åºçš„ä¸€æ¬¡æ‰§è¡Œè¿‡ç¨‹ï¼Œå®ƒæ˜¯ä¸€ä¸ªåŠ¨æ€çš„æ¦‚å¿µã€‚æ˜¯ç³»ç»Ÿèµ„æºåˆ†é…çš„å•ä½ã€‚
- é€šå¸¸åœ¨ä¸€ä¸ªè¿›ç¨‹ä¸­å¯ä»¥åŒ…å«è‹¥å¹²ä¸ª**çº¿ç¨‹**ï¼Œå½“ç„¶ä¸€ä¸ªè¿›ç¨‹ä¸­è‡³å°‘æœ‰ä¸€ä¸ªçº¿ç¨‹ï¼Œä¸ç„¶æ²¡æœ‰å­˜åœ¨çš„æ„ä¹‰ã€‚çº¿ç¨‹æ˜¯CPUè°ƒåº¦å’Œæ‰§è¡Œå•ä½ã€‚

> âš ï¸æ³¨æ„ï¼šå¾ˆå¤šå¤šçº¿ç¨‹æ˜¯æ¨¡æ‹Ÿå‡ºæ¥çš„ï¼ŒçœŸæ­£çš„å¤šçº¿ç¨‹æ˜¯æŒ‡æœ‰å¤šä¸ªCPUï¼Œå³å¤šæ ¸ï¼Œå¦‚æœåŠ¡å™¨ã€‚å¦‚æœæ˜¯æ¨¡æ‹Ÿå‡ºæ¥çš„å¤šçº¿ç¨‹ï¼Œå³åœ¨ä¸€ä¸ªCPUçš„æƒ…å†µä¸‹ï¼Œåœ¨åŒä¸€ä¸ªæ—¶é—´ç‚¹ï¼ŒCPUåªèƒ½æ‰§è¡Œä¸€ä¸ªä»£ç ï¼Œå› ä¸ºåˆ‡æ¢çš„å¾ˆå¿«ï¼Œæ‰€ä»¥å°±æœ‰åŒæ—¶æ‰§è¡Œçš„é”™è§‰ã€‚

### ä¸€äº›æ ¸å¿ƒæ¦‚å¿µ

- çº¿ç¨‹å°±æ˜¯ç‹¬ç«‹æ‰§è¡Œçš„è·¯å¾„
- åœ¨ç¨‹åºè¿è¡Œæ—¶ï¼Œå³ä½¿æ²¡æœ‰è‡ªå·±åˆ›å»ºçº¿ç¨‹ï¼Œåå°ä¹Ÿä¼šæœ‰å¤šä¸ªçº¿ç¨‹ï¼Œå¦‚ä¸»çº¿ç¨‹ã€gcçº¿ç¨‹
- main() ç§°ä¹‹ä¸ºä¸»çº¿ç¨‹ï¼Œä¸ºç³»ç»Ÿçš„å…¥å£ï¼Œç”¨äºæ‰§è¡Œæ•´ä¸ªç¨‹åº
- åœ¨ä¸€ä¸ªè¿›ç¨‹ä¸­ï¼Œå¦‚æœå¼€è¾Ÿäº†å¤šä¸ªçº¿ç¨‹ï¼Œçº¿ç¨‹çš„è¿è¡Œç”±è°ƒåº¦å™¨å®‰æ’è°ƒåº¦ï¼Œè°ƒåº¦å™¨æ˜¯ä¸æ“ä½œç³»ç»Ÿç´§å¯†ç›¸å…³çš„ï¼Œå…ˆåé¡ºåºæ˜¯ä¸èƒ½äººä¸ºå¹²é¢„çš„
- å¯¹åŒä¸€ä»½èµ„æºæ“ä½œæ—¶ï¼Œä¼šå­˜åœ¨èµ„æºæŠ¢å¤ºçš„é—®é¢˜ï¼Œéœ€è¦åŠ å…¥å¹¶å‘æ§åˆ¶
- çº¿ç¨‹ä¼šå¸¦æ¥é¢å¤–çš„å¼€é”€ï¼Œå¦‚cpuè°ƒåº¦æ—¶é—´ï¼Œå¹¶å‘æ§åˆ¶å¼€é”€
- æ¯ä¸ªçº¿ç¨‹åœ¨è‡ªå·±çš„å·¥ä½œå†…å­˜äº¤äº’ï¼Œå†…å­˜æ§åˆ¶ä¸å½“ä¼šé€ æˆæ•°æ®ä¸ä¸€è‡´

## çº¿ç¨‹åˆ›å»º

### ä¸‰ç§åˆ›å»ºæ–¹å¼

- ç»§æ‰¿Threadç±»ï¼ˆé‡ç‚¹ï¼‰
- å®ç°Runnableæ¥å£ï¼ˆé‡ç‚¹ï¼‰
- å®ç°Callableæ¥å£ï¼ˆäº†è§£ï¼‰

### Thread

- è‡ªå®šä¹‰çº¿ç¨‹ç±»ç»§æ‰¿ `Threadç±»` 
- é‡å†™ `run()` æ–¹æ³•ï¼Œç¼–å†™çº¿ç¨‹æ‰§è¡Œä½“
- åˆ›å»ºçº¿ç¨‹å¯¹è±¡ï¼Œè°ƒç”¨ `start()` æ–¹æ³•å¯åŠ¨çº¿ç¨‹

```java
public class StartThread extends Thread {
	// çº¿ç¨‹å…¥å£ç‚¹
	@Override
	public void run() {
		// çº¿ç¨‹ä½“
	}
}
```

```java
public static void main(String[] args) {
	// åˆ›å»ºçº¿ç¨‹å¯¹è±¡
	StartThread t = new StartThread();
	t.start();
}
```

>âš ï¸ æ³¨æ„ï¼šçº¿ç¨‹ä¸ä¸€å®šç«‹å³æ‰§è¡Œï¼Œç”±CPUå®‰æ’è°ƒåº¦ã€‚

#### æ¡ˆä¾‹ï¼šå›¾ç‰‡ä¸‹è½½

```java
import org.apache.commons.io.FileUtils;  
  
import java.io.File;  
import java.io.IOException;  
import java.net.URL;  
  
public class TestThread extends Thread {  
  
    private String url; // ç½‘ç»œå›¾ç‰‡åœ°å€  
    private String name; // ä¿å­˜çš„æ–‡ä»¶å  
  
    public static void main(String[] args) {  
        TestThread t1 = new TestThread("https://blog.kuangstudy.con/usr/themes/handsome/usr/img/sj/2.jpg", "1.jpg");  
        TestThread t2 = new TestThread("https://blog.kuangstudy.con/usr/themes/handsome/usr/img/sj/2.jpg", "2.jpg");  
        TestThread t3 = new TestThread("https://blog.kuangstudy.con/usr/themes/handsome/usr/img/sj/2.jpg", "3.jpg");  
  
        new Thread(t1).start();  
		new Thread(t2).start();  
		new Thread(t3).start();  
    }  
  
    public TestThread(String url, String name) {  
        this.url = url;  
        this.name = name;  
    }  
  
    // ä¸‹è½½å›¾ç‰‡çº¿ç¨‹çš„æ‰§è¡Œä½“  
    @Override  
    public void run() {  
        WenDownloader wenDownloader = new WenDownloader();  
        wenDownloader.downloader(url, name);  
        System.out.println("ä¸‹è½½äº†æ–‡ä»¶åä¸ºï¼š" + name);  
    }  
}  
  
// ä¸‹è½½å™¨  
class WenDownloader {  
    // ä¸‹è½½æ–¹æ³•  
    public void downloader() {  
        try {  
            FileUtils.copyURLToFile(new URL(url), new File(name));  
        } catch (IOException e) {  
            e.printStackTrace();  
            System.out.println("IOå¼‚å¸¸ï¼Œdownloaderæ–¹æ³•å‡ºç°é—®é¢˜");  
        }  
    }  
}
```

### å®ç°Runnableæ¥å£

```java
public class TestThread implements Runnable {  
  
    // ç¥¨æ•°  
    private int ticketNums = 10;  
  
    @Override  
    public void run() {  
        while (true) {  
            if (ticketNums <= 0) {  
                break;  
            }  
            // æ¨¡æ‹Ÿå»¶è¿Ÿ  
            try {  
                Thread.sleep(200);  
            } catch (InterruptedException e) {  
                throw new RuntimeException(e);  
            }  
            System.out.println(Thread.currentThread().getName() + "æ‹¿åˆ°äº†ç¬¬" + ticketNums-- + "ç¥¨");  
        }  
    }  
  
    public static void main(String[] args) {  
        TestThread ticket = new TestThread();  
  
        new Thread(ticket, "å°æ˜").start();  
        new Thread(ticket, "å¼ ä¸‰").start();  
        new Thread(ticket, "æå››").start();  
    }  
}
```

#### æ¡ˆä¾‹ï¼šé¾Ÿå…”èµ›è·‘

```java
// æ¨¡æ‹Ÿé¾Ÿå…”èµ›è·‘  
public class Race implements Runnable {  
  
    // èƒœåˆ©è€…  
    private static String winner;  
  
    @Override  
    public void run() {  
        for (int i = 0; i <= 100; i++) {  
  
            // æ¨¡æ‹Ÿå…”å­ä¼‘æ¯  
            if (Thread.currentThread().getName().equals("å…”å­") && i % 10 == 0) {  
                try {  
                    Thread.sleep(200);  
                } catch (InterruptedException e) {  
                    throw new RuntimeException(e);  
                }  
            }  
  
            // åˆ¤æ–­æ¯”èµ›æ˜¯å¦ç»“æŸ  
            boolean flag = gameOver(i);  
  
            if (flag) {  
                // å¦‚æœæ¯”èµ›ç»“æŸäº†ï¼Œå°±åœæ­¢ç¨‹åº  
                break;  
            }  
  
            System.out.println(Thread.currentThread().getName() + "-->è·‘äº†" + i + 'æ­¥');  
        }  
    }  
  
    // åˆ¤æ–­æ˜¯å¦å®Œæˆæ¯”èµ›  
    private boolean gameOver(int steps) {  
        // åˆ¤æ–­æ˜¯å¦æœ‰èƒœåˆ©è€…  
        if (winner != null) {  
            // å·²ç»å­˜åœ¨èƒœåˆ©è€…  
            return true;  
        }  
        {            if (steps >= 100) {  
                winner = Thread.currentThread().getName();  
                System.out.println("winner is " + winner);  
                return true;  
            }  
        }  
        return false;  
    }  
  
    public static void main(String[] args) {  
        Race race = new Race();  
  
        new Thread(race, "å…”å­").start();  
        new Thread(race, "ä¹Œé¾Ÿ").start();  
    }  
}
```

### å®ç°Callableæ¥å£ï¼ˆäº†è§£å³å¯ï¼‰

1. å®ç°Callableæ¥å£ï¼Œéœ€è¦è¿”å›å€¼ç±»å‹
2. é‡å†™call()æ–¹æ³•ï¼Œéœ€è¦æŠ›å‡ºå¼‚å¸¸
3. åˆ›å»ºç›®æ ‡å¯¹è±¡
4. åˆ›å»ºæ‰§è¡ŒæœåŠ¡ï¼š`ExecutorService ser = Executors.newFixedThreadPool(1);` 
5. æäº¤æ‰§è¡Œï¼š`Future<Boolean> result1 = ser.submit(t1);` 
6. è·å–ç»“æœï¼š`boolean r1 = result1.get();` 
7. å…³é—­æœåŠ¡ï¼š`ser.shutdownNow();` 

#### æ¼”ç¤ºï¼šåˆ©ç”¨callableæ”¹é€ ä¸‹è½½å›¾ç‰‡æ¡ˆä¾‹

```java
import org.apache.commons.io.FileUtils;  
  
import java.io.IOException;  
import java.util.concurrent.*;  
  
public class TestCallable implements Callable<Boolean> {  
  
    private String url; // ç½‘ç»œå›¾ç‰‡åœ°å€  
    private String name; // ä¿å­˜çš„æ–‡ä»¶å  
  
    public static void main(String[] args) throws ExecutionException, InterruptedException {  
        TestCallable t1 = new TestCallable("https://blog.kuangstudy.con/usr/themes/handsome/usr/img/sj/2.jpg", "1.jpg");  
        TestCallable t2 = new TestCallable("https://blog.kuangstudy.con/usr/themes/handsome/usr/img/sj/2.jpg", "2.jpg");  
        TestCallable t3 = new TestCallable("https://blog.kuangstudy.con/usr/themes/handsome/usr/img/sj/2.jpg", "3.jpg");  
  
        // åˆ›å»ºæ‰§è¡ŒæœåŠ¡  
        ExecutorService ser = Executors.newFixedThreadPool(3);  
  
        // æäº¤æ‰§è¡Œ  
        Future<Boolean> result1 = ser.submit(t1);  
        Future<Boolean> result2 = ser.submit(t2);  
        Future<Boolean> result3 = ser.submit(t3);  
  
        // è·å–ç»“æœ  
        boolean r1 = result1.get();  
        boolean r2 = result2.get();  
        boolean r3 = result3.get();  
  
        System.out.println(r1);  
        System.out.println(r2);  
        System.out.println(r3);  
  
        // å…³é—­æœåŠ¡  
        ser.shutdownNow();  
    }  
  
    public TestCallable(String url, String name) {  
        this.url = url;  
        this.name = name;  
    }  
  
    // ä¸‹è½½å›¾ç‰‡çº¿ç¨‹çš„æ‰§è¡Œä½“  
    @Override  
    public Boolean call() throws Exception {  
        WenDownloader wenDownloader = new WenDownloader();  
        wenDownloader.downloader(url, name);  
        System.out.println("ä¸‹è½½äº†æ–‡ä»¶åä¸ºï¼š" + name);  
        return true;  
    }  
}  
  
// ä¸‹è½½å™¨  
class WenDownloader {  
    // ä¸‹è½½æ–¹æ³•  
    public void downloader() {  
        try {  
            FileUtils.copyURLToFile(new URL(url), new File(name));  
        } catch (IOException e) {  
            e.printStackTrace();  
            System.out.println("IOå¼‚å¸¸ï¼Œdownloaderæ–¹æ³•å‡ºç°é—®é¢˜");  
        }  
    }  
}
```

>ğŸ”callable çš„å¥½å¤„ï¼š
>1. å¯ä»¥å®šä¹‰è¿”å›å€¼
>2. å¯ä»¥æŠ›å‡ºå¼‚å¸¸

### é™æ€ä»£ç†

```java
public class TestStaticProxy {  
    public static void main(String[] args) {  
        You you = new You();  
          
        new Thread(() -> System.out.println("æˆ‘çˆ±ä½ ")).start();  
          
        new WeddingCompany(you).HappyMarry();  
    }  
}  
  
interface Marry{  
    void HappyMarry();  
}  
  
// çœŸå®è§’è‰²  
class You implements Marry{  
  
    @Override  
    public void HappyMarry() {  
        System.out.println("xxxè¦ç»“å©šäº†ï¼");  
    }  
}  
  
// ä»£ç†è§’è‰²  
class WeddingCompany implements Marry{  
  
    private Marry target;  
  
    public WeddingCompany(Marry target) {  
        this.target = target;  
    }  
  
    @Override  
    public void HappyMarry() {  
        before();  
        this.target.HappyMarry();  
        after();  
    }  
  
    private void after() {  
        System.out.println("ç»“å©šä¹‹åï¼Œæ”¶å°¾æ¬¾");  
    }  
  
    private void before() {  
        System.out.println("ç»“å©šä¹‹å‰ï¼Œå¸ƒç½®ç°åœº");  
    }  
}
```

>ğŸ”é™æ€ä»£ç†æ¨¡å¼æ€»ç»“ï¼š
>1. çœŸå®å¯¹è±¡å’Œä»£ç†å¯¹è±¡éƒ½è¦å®ç°åŒä¸€ä¸ªæ¥å£
>2. ä»£ç†å¯¹è±¡è¦ä»£ç†çœŸå®è§’è‰²
>3. å¥½å¤„
>	1. ä»£ç†å¯¹è±¡å¯ä»¥åšå¾ˆå¤šçœŸå®å¯¹è±¡åšä¸äº†çš„äº‹æƒ…
>	2. çœŸå®å¯¹è±¡ä¸“æ³¨åšè‡ªå·±çš„äº‹æƒ…

## Lambdaè¡¨è¾¾å¼

- é¿å…åŒ¿åå†…éƒ¨ç±»å®šä¹‰è¿‡å¤š
- å…¶å®è´¨å±äºå‡½æ•°å¼ç¼–ç¨‹çš„æ¦‚å¿µ

```java
(params) -> expression [è¡¨è¾¾å¼]
(params) -> statement [è¯­å¥]
(params) -> {statements}
```

```java
a -> System.out.println("i like lamda-->" + a);
```

```java
new Thread(() -> System.out.println("å¤šçº¿ç¨‹å­¦ä¹ ...")).start();
```

- ä¸ºä»€ä¹ˆè¦ä½¿ç”¨Lambdaè¡¨è¾¾å¼
	- é¿å…åŒ¿åå†…éƒ¨ç±»å®šä¹‰è¿‡å¤š
	- å¯ä»¥è®©ä»£ç çœ‹èµ·æ¥æ›´ç®€æ´
	- å»æ‰äº†ä¸€å †æ²¡æœ‰æ„ä¹‰çš„ä»£ç ï¼Œåªç•™ä¸‹æ ¸å¿ƒçš„é€»è¾‘
- ç†è§£Functional Interfaceï¼ˆå‡½æ•°å¼æ¥å£ï¼‰æ˜¯å­¦ä¹ Java8 Lambda è¡¨è¾¾å¼çš„å…³é”®æ‰€åœ¨
- å‡½æ•°å¼æ¥å£çš„å®šä¹‰ï¼š
	- ä»»ä½•æ¥å£ï¼Œå¦‚æœåªåŒ…å«å”¯ä¸€ä¸€ä¸ªæŠ½è±¡æ–¹æ³•ï¼Œé‚£ä¹ˆå®ƒå°±æ˜¯ä¸€ä¸ªå‡½æ•°å¼æ¥å£
	```java
	public interface Runnable {
		public abstract void run();
	}
	```
	- å¯¹äºå‡½æ•°å¼æ¥å£ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡Lambdaè¡¨è¾¾å¼æ¥åˆ›å»ºè¯¥æ¥å£çš„å¯¹è±¡
	- æ¼”ç¤ºï¼šä»£ç æ¨å¯¼Lambdaè¡¨è¾¾å¼

```java
/**  
 * æ¨åˆ°Lambdaè¡¨è¾¾å¼  
 */  
public class TestLambda {  
  
    // 3ã€é™æ€å†…éƒ¨ç±»  
    static class Like2 implements ILike{  
  
        @Override  
        public void lambda() {  
            System.out.println("i like lambda2");  
        }  
    }  
  
    public static void main(String[] args) {  
        ILike like = new Like();  
        like.lambda();  
  
        like = new Like2();  
        like.lambda();  
  
        // 4ã€å±€éƒ¨å†…éƒ¨ç±»  
        class Like3 implements ILike{  
  
            @Override  
            public void lambda() {  
                System.out.println("i like lambda3");  
            }  
        }  
  
        like = new Like3();  
        like.lambda();  
  
        // 5ã€åŒ¿åå†…éƒ¨ç±»ï¼šæ²¡æœ‰ç±»çš„åç§°ï¼Œå¿…é¡»å€ŸåŠ©æ¥å£æˆ–è€…çˆ¶ç±»  
        like = new ILike() {  
            @Override  
            public void lambda() {  
                System.out.println("i like lambda4");  
            }  
        };  
        like.lambda();  
  
        // 6ã€ç”¨Lambdaç®€åŒ–  
        like = () -> System.out.println("i like lambda5");  
        like.lambda();  
    }  
}  
  
// 1ã€å®šä¹‰ä¸€ä¸ªå‡½æ•°å¼æ¥å£  
interface ILike{  
    void lambda();  
}  
  
// 2ã€å®ç°ç±»  
class Like implements ILike{  
  
    @Override  
    public void lambda() {  
        System.out.println("i like lambda");  
    }  
}
```

>ğŸ”æ€»ç»“ï¼š
>1. Lambdaè¡¨è¾¾å¼åœ¨åªæœ‰ä¸€è¡Œä»£ç çš„æƒ…å†µä¸‹æ‰èƒ½ç®€åŒ–æˆä¸ºä¸€è¡Œï¼Œå¦‚æœæœ‰å¤šè¡Œï¼Œé‚£ä¹ˆå°±ç”¨ä»£ç å—åŒ…è£¹
>2. å‰ææ˜¯æ¥å£æ—¶å‡½æ•°å¼æ¥å£
>3. å¤šä¸ªå‚æ•°ä¹Ÿå¯ä»¥å»æ‰å‚æ•°ç±»å‹ï¼Œè¦å»æ‰å°±éƒ½å»æ‰ï¼Œä½†å¿…é¡»åŠ ä¸Šæ‹¬å·

## çº¿ç¨‹çŠ¶æ€

### äº”å¤§çŠ¶æ€

![](https://i0.hdslb.com/bfs/album/f4f27b77017fa6edbee4ef4a322803dc267967e5.png)

![](https://i0.hdslb.com/bfs/album/1ce6e4c57382ba40269820aeed20de61f1f19f94.png)

### çº¿ç¨‹æ–¹æ³•

| æ–¹æ³•                           | è¯´æ˜                                       |
| :------------------------------: | :------------------------------------------: |
| setPriority(int newPriority)   | æ›´æ”¹çº¿ç¨‹ä¼˜å…ˆçº§                             |
| static void sleep(long millis) | åœ¨æŒ‡å®šçš„æ¯«ç§’æ•°å†…è®©å½“å‰æ­£åœ¨æ‰§è¡Œçš„çº¿ç¨‹ä¼‘çœ    |
| void join()                    | ç­‰å¾…è¯¥çº¿ç¨‹ç»ˆæ­¢                             |
| static void yield()            | æš‚åœå½“å‰æ­£åœ¨æ‰§è¡Œçš„çº¿ç¨‹å¯¹è±¡ï¼Œå¹¶æ‰§è¡Œå…¶ä»–çº¿ç¨‹ |
| void interrupt()               | ä¸­æ–­çº¿ç¨‹ï¼Œ**åˆ«ç”¨è¿™ä¸ªæ–¹å¼**                     |
| boolean isAlive()              | æµ‹è¯•çº¿ç¨‹æ˜¯å¦å¤„äºæ´»åŠ¨çŠ¶æ€                   | 

### åœæ­¢çº¿ç¨‹

- ä¸æ¨èä½¿ç”¨JDKæä¾›çš„ stop()ã€destory() æ–¹æ³•ã€‚ã€å·²åºŸå¼ƒã€‘
- æ¨èçº¿ç¨‹è‡ªå·±åœä¸‹æ¥
- å»ºè®®ä½¿ç”¨ä¸€ä¸ªæ ‡å¿—ä½è¿›è¡Œç»ˆæ­¢å˜é‡ï¼Œå½“ flag=falseï¼Œåˆ™çº¿ç¨‹ç»ˆæ­¢è¿è¡Œ

```java
public class TestStop implements Runnable {
	// 1. çº¿ç¨‹ä¸­å®šä¹‰çº¿ç¨‹ä½¿ç”¨çš„æ ‡è¯†
	private boolean flag = true;

	@Override
	public void run() {
		// 2. çº¿ç¨‹ä½“ä½¿ç”¨è¯¥æ ‡è¯†
		while (flag) {
			System.out.println("run... Thread");
		}
	}

	// 3. å¯¹å¤–æä¾›æ–¹æ³•æ”¹å˜æ ‡è¯†
	public void stop() {
		this.flag = false;
	}

	public static void main(String[] args) {
		TestStop testStop = new TestStop();

		new Thread(testStop).start();

		for (int i = 0, i < 1000, i++) {
			System.out.println("main" + i);
			if (i == 900) {
				// è°ƒç”¨stopæ–¹æ³•åˆ‡æ¢æ ‡å¿—ä½ï¼Œè®©çº¿ç¨‹åœæ­¢
				testStop.stop();
				System.out.println("çº¿ç¨‹è¯¥åœæ­¢äº†");
			}
		}
	}
}
```

### çº¿ç¨‹ä¼‘çœ 

- sleep(æ—¶é—´) æŒ‡å®šå½“å‰çº¿ç¨‹é˜»å¡çš„æ¯«ç§’æ•°
- sleep å­˜åœ¨å¼‚å¸¸ InterruptedException
- sleep æ—¶é—´åˆ°è¾¾åçº¿ç¨‹è¿›å…¥å°±ç»ªçŠ¶æ€
- sleep å¯ä»¥æ¨¡æ‹Ÿç½‘ç»œå»¶æ—¶ï¼Œå€’è®¡æ—¶ç­‰
- æ¯ä¸€ä¸ªå¯¹è±¡éƒ½æœ‰ä¸€ä¸ªé”ï¼Œsleep ä¸ä¼šé‡Šæ”¾é”

#### æ¼”ç¤ºï¼šè®¡æ—¶

```java
import java.text.SimpleDateFormat;  
import java.util.Date;  
  
// æ¨¡æ‹Ÿå€’è®¡æ—¶  
public class TestSleep {  
  
    public static void main(String[] args) throws InterruptedException {  
        tenDown();  
          
        // æ‰“å°å½“å‰ç³»ç»Ÿæ—¶é—´  
        Date startTime = new Date(System.currentTimeMillis());  
          
        while (true) {  
            Thread.sleep(1000);  
            System.out.println(new SimpleDateFormat("HH:mm:ss").format(startTime));  
            // æ›´æ–°å½“å‰æ—¶é—´  
            startTime = new Date(System.currentTimeMillis());  
        }  
    }  
  
    public static void tenDown() throws InterruptedException {  
        int num= 10;  
        while (true ) {  
            Thread.sleep(1000);  
            System.out.println(num--);  
            if (num<=0) {  
                break;  
            }  
        }  
    }  
}
```

### çº¿ç¨‹ç¤¼è®©

- ç¤¼è®©çº¿ç¨‹ï¼Œè®©å½“å‰æ­£åœ¨æ‰§è¡Œçš„çº¿ç¨‹æš‚åœï¼Œä½†ä¸é˜»å¡
- å°†çº¿ç¨‹ä»è¿è¡ŒçŠ¶æ€è½¬ä¸ºå°±ç»ªçŠ¶æ€
- **è®©cpué‡æ–°è°ƒåº¦ï¼Œç¤¼è®©ä¸ä¸€å®šæˆåŠŸï¼çœ‹cpuå¿ƒæƒ…** 

```java
// æµ‹è¯•ç¤¼è®©çº¿ç¨‹  
// ç¤¼è®©ä¸ä¸€å®šæˆåŠŸï¼Œçœ‹cpuå¿ƒæƒ…  
public class TestYield {  
    public static void main(String[] args) {  
        MyYield myYield = new MyYield();  
  
        new Thread(myYield, "a").start();  
        new Thread(myYield, "b").start();  
    }  
}  
  
class MyYield implements Runnable {  
  
    @Override  
    public void run() {  
        System.out.println(Thread.currentThread().getName() + "çº¿ç¨‹å¼€å§‹æ‰§è¡Œ");  
        // ç¤¼è®©  
        Thread.yield();  
        System.out.println(Thread.currentThread().getName() + "çº¿ç¨‹åœæ­¢æ‰§è¡Œ");  
    }  
}
```

### Join

- Join åˆå¹¶çº¿ç¨‹ï¼Œå¾…æ­¤çº¿ç¨‹æ‰§è¡Œå®Œæˆåï¼Œå†æ‰§è¡Œå…¶ä»–çº¿ç¨‹ï¼Œå…¶ä»–çº¿ç¨‹é˜»å¡
- å¯ä»¥æƒ³è±¡æˆæ’é˜Ÿ

```java
public class TestJoin implements Runnable {  
    @Override  
    public void run() {  
        for (int i = 0; i < 100; i++) {  
            System.out.println("çº¿ç¨‹VIPæ¥äº†" + i);  
        }  
    }  
  
    public static void main(String[] args) throws InterruptedException {  
        // å¯åŠ¨çº¿ç¨‹  
        TestJoin testJoin = new TestJoin();  
        Thread thread = new Thread(testJoin);  
        thread.start();  
  
        //ä¸»çº¿ç¨‹  
        for (int i = 0; i < 1000; i++) {  
            if (i == 200) {  
                // æ’é˜Ÿ  
                thread.join();  
            }  
            System.out.println("main" + i);  
        }  
    }  
}
```

### çº¿ç¨‹çŠ¶æ€è§‚æµ‹

- Thread.State
	- **NEW**
	  å°šæœªå¯åŠ¨çš„çº¿ç¨‹å¤„äºæ­¤çŠ¶æ€
	- **RUNNABLE**
	  åœ¨Javaè™šæ‹Ÿæœºä¸­æ‰§è¡Œçš„çº¿ç¨‹å¤„äºæ­¤çŠ¶æ€
	- **BLOCKED**
	  è¢«é˜»å¡ç­‰å¾…ç›‘è§†å™¨é”å®šçš„çº¿ç¨‹å¤„äºæ­¤çŠ¶æ€
	- **WAITING**
	  æ­£åœ¨ç­‰å¾…å¦ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œç‰¹å®šåŠ¨ä½œçš„çº¿ç¨‹å¤„äºæ­¤çŠ¶æ€
	- **TIMED_WAITING**
	  æ­£åœ¨ç­‰å¾…å¦ä¸€ä¸ªçº¿ç¨‹æ‰§è¡ŒåŠ¨ä½œè¾¾åˆ°æŒ‡å®šç­‰å¾…æ—¶é—´çš„çº¿ç¨‹å¤„äºæ­¤çŠ¶æ€
	- **TERMINATED**
	  å·²é€€å‡ºçš„çº¿ç¨‹å¤„äºæ­¤çŠ¶æ€
- ä¸€ä¸ªçº¿ç¨‹å¯ä»¥åœ¨ç»™å®šæ—¶é—´ç‚¹å¤„äºä¸€ä¸ªçŠ¶æ€ã€‚è¿™äº›çŠ¶æ€æ˜¯ä¸åæ˜ ä»»ä½•æ“ä½œç³»ç»Ÿçº¿ç¨‹çŠ¶æ€çš„è™šæ‹ŸæœºçŠ¶æ€ã€‚

```java
// è§‚å¯Ÿæµ‹è¯•çº¿ç¨‹çš„çŠ¶æ€  
public class TestState {  
    public static void main(String[] args) {  
        Thread thread = new Thread(() -> {  
            for (int i = 0; i < 5; i++) {  
                try {  
                    Thread.sleep(1000);  
                } catch (InterruptedException e) {  
                    throw new RuntimeException(e);  
                }  
            }  
            System.out.println(".....");  
        });  
  
        // è§‚å¯ŸçŠ¶æ€  
        Thread.State state = thread.getState();  
        System.out.println(state); // NEW  
  
        // è§‚å¯Ÿå¯åŠ¨å  
        thread.start();  
        state = thread.getState();  
        System.out.println(state); // RUNNABLE  
  
        // åªè¦çº¿ç¨‹ä¸ç»ˆæ­¢å°±ä¸€ç›´è¾“å‡ºçŠ¶æ€  
        while (state != Thread.State.TERMINATED) {  
            try {  
                Thread.sleep(100);  
            } catch (InterruptedException e) {  
                throw new RuntimeException(e);  
            }  
            state = thread.getState();  
            System.out.println(state);  
        }  
    }  
}
```

### çº¿ç¨‹ä¼˜å…ˆçº§

- Javaæä¾›ä¸€ä¸ªçº¿ç¨‹è°ƒåº¦å™¨æ¥ç¨‹åºä¸­å¯åŠ¨åè¿›å…¥å°±ç»ªçŠ¶æ€çš„æ‰€æœ‰çº¿ç¨‹ï¼Œçº¿ç¨‹è°ƒåº¦å™¨æŒ‰ç…§ä¼˜å…ˆçº§å†³å®šåº”è¯¥è°ƒåº¦å“ªä¸ªçº¿ç¨‹æ¥æ‰§è¡Œã€‚
- çº¿ç¨‹çš„ä¼˜å…ˆçº§ç”¨æ•°å­—è¡¨ç¤ºï¼ŒèŒƒå›´ä»1~10
	- `Thread.MIN_PRIORITY = 1;` 
	- `Thread.MAX_PRIORITY = 10;` 
	- `Thread.NORM_PRIORITY = 5;` 
- ä½¿ç”¨ä»¥ä¸‹æ–¹æ³•æ”¹å˜æˆ–è·å–ä¼˜å…ˆçº§
	- `getPriority()` 
	- `setPriority(int xxx)` 

```java
// æµ‹è¯•çº¿ç¨‹ä¼˜å…ˆçº§  
public class TestPriority {  
    public static void main(String[] args) {  
        // ä¸»çº¿ç¨‹é»˜è®¤ä¼˜å…ˆçº§  
        System.out.println(Thread.currentThread().getName() + "-->" + Thread.currentThread().getPriority());  
  
        MyPriority myPriority = new MyPriority();  
  
        Thread thread1 = new Thread(myPriority);  
        Thread thread2 = new Thread(myPriority);  
        Thread thread3 = new Thread(myPriority);  
        Thread thread4 = new Thread(myPriority);  
        Thread thread5 = new Thread(myPriority);  
        Thread thread6 = new Thread(myPriority);  
  
        // å…ˆè®¾ç½®ä¼˜å…ˆçº§å†å¯åŠ¨  
        thread1.start();  
  
        thread2.setPriority(1);  
        thread2.start();  
  
        thread3.setPriority(4);  
        thread3.start();  
  
        thread4.setPriority(Thread.MAX_PRIORITY); // 10  
        thread4.start();  
  
        thread5.setPriority(8);  
        thread5.start();  
  
        thread6.setPriority(7);  
        thread6.start();  
    }  
}  
  
class MyPriority implements Runnable {  
  
    @Override  
    public void run() {  
        System.out.println(Thread.currentThread().getName() + "-->" + Thread.currentThread().getPriority());  
    }  
}
```

>âš ï¸ä¼˜å…ˆçº§ä½åªæ˜¯æ„å‘³ç€è·å¾—è°ƒåº¦çš„æ¦‚ç‡ä½ï¼Œå¹¶ä¸æ˜¯ä¼˜å…ˆçº§ä½å°±ä¸ä¼šè¢«è°ƒç”¨äº†ï¼Œè¿™éƒ½æ˜¯çœ‹CPUçš„è°ƒåº¦ã€‚

### å®ˆæŠ¤ï¼ˆdaemonï¼‰çº¿ç¨‹

- çº¿ç¨‹åˆ†ä¸º**ç”¨æˆ·çº¿ç¨‹**å’Œ**å®ˆæŠ¤çº¿ç¨‹** 
- è™šæ‹Ÿæœºå¿…é¡»ç¡®ä¿ç”¨æˆ·çº¿ç¨‹æ‰§è¡Œå®Œæ¯•
- è™šæ‹Ÿæœºä¸ç”¨ç­‰å¾…å®ˆæŠ¤çº¿ç¨‹æ‰§è¡Œå®Œæ¯•
- å¦‚ï¼šåå°è®°å½•æ“ä½œæ—¥å¿—ã€ç›‘æ§å†…å­˜ã€åƒåœ¾å›æ”¶ç­‰ç­‰

```java
// æµ‹è¯•å®ˆæŠ¤çº¿ç¨‹  
public class TestDaemon {  
    public static void main(String[] args) {  
        God god = new God();  
        You you = new You();  
  
        Thread thread = new Thread(god);  
        thread.setDaemon(true); // é»˜è®¤æ˜¯falseï¼Œè¡¨ç¤ºæ˜¯ç”¨æˆ·çº¿ç¨‹  
        thread.start();  
  
        new Thread(you).start();  
    }  
}  
  
// ä¸Šå¸  
class God implements Runnable {  
    @Override  
    public void run() {  
        while (true) {  
            System.out.println("ä¸Šå¸åŒ…ä¿ä½‘è€…ä½ ");  
        }  
    }  
}  
  
// ä½   
class You implements Runnable {  
    @Override  
    public void run() {  
        for (int i = 0; i < 36500; i++) {  
            System.out.println("ä½ ä¸€ç”Ÿéƒ½å¼€å¿ƒçš„æ´»ç€");  
        }  
        System.out.println("Goodbye World!");  
    }  
}
```

## çº¿ç¨‹åŒæ­¥

å¤šä¸ªçº¿ç¨‹æ“ä½œåŒä¸€ä¸ªèµ„æº

### å¹¶å‘

- å¹¶å‘ï¼šåŒä¸€ä¸ªå¯¹è±¡è¢«å¤šä¸ªçº¿ç¨‹åŒæ—¶æ“ä½œ
- å¤„ç†å¤šçº¿ç¨‹é—®é¢˜æ—¶ï¼Œå¤šä¸ªçº¿ç¨‹è®¿é—®åŒä¸€ä¸ªå¯¹è±¡ï¼Œå¹¶ä¸”æŸäº›çº¿ç¨‹è¿˜æƒ³ä¿®æ”¹è¿™ä¸ªå¯¹è±¡ï¼Œè¿™æ—¶å€™æˆ‘ä»¬å°±éœ€è¦çº¿ç¨‹åŒæ­¥ã€‚çº¿ç¨‹åŒæ­¥å…¶å®å°±æ˜¯ä¸€ç§ç­‰å¾…æœºåˆ¶ï¼Œå¤šä¸ªéœ€è¦åŒæ—¶è®¿é—®æ­¤å¯¹è±¡çš„çº¿ç¨‹è¿›å…¥è¿™ä¸ª**å¯¹è±¡çš„ç­‰å¾…æ± **å½¢æˆé˜Ÿåˆ—ï¼Œç­‰å¾…å‰é¢çº¿ç¨‹ä½¿ç”¨å®Œæ¯•ï¼Œä¸‹ä¸€ä¸ªçº¿ç¨‹å†ä½¿ç”¨ã€‚

### çº¿ç¨‹åŒæ­¥

- ç”±äºåŒä¸€è¿›ç¨‹çš„å¤šä¸ªçº¿ç¨‹å…±äº«åŒä¸€å—å­˜å‚¨ç©ºé—´ï¼Œåœ¨å¸¦æ¥æ–¹ä¾¿çš„åŒæ—¶ï¼Œä¹Ÿå¸¦æ¥äº†è®¿é—®å†²çªçš„é—®é¢˜ï¼Œä¸ºäº†ä¿è¯æ•°æ®åœ¨æ–¹æ³•ä¸­è¢«è®¿é—®æ—¶çš„æ­£ç¡®æ€§ï¼Œåœ¨è®¿é—®æ—¶åŠ å…¥**é”æœºåˆ¶ synchronized**ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹è·å¾—å¯¹è±¡çš„æ’ä»–é”ï¼Œç‹¬å èµ„æºï¼Œå…¶ä»–çº¿ç¨‹å¿…é¡»ç­‰å¾…ï¼Œä½¿ç”¨åé‡Šæ”¾é”å³å¯ã€‚
- å­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š
	- ä¸€ä¸ªçº¿ç¨‹æŒæœ‰é”ä¼šå¯¼è‡´å…¶ä»–æ‰€æœ‰éœ€è¦æ­¤é”çš„çº¿ç¨‹æŒ‚èµ·
	- åœ¨å¤šçº¿ç¨‹ç«äº‰ä¸‹ï¼ŒåŠ é”ã€é‡Šæ”¾é”ä¼šå¯¼è‡´æ¯”è¾ƒå¤šçš„ä¸Šä¸‹æ–‡åˆ‡æ¢å’Œè°ƒåº¦å»¶æ—¶ï¼Œå¼•èµ·æ€§èƒ½é—®é¢˜
	- å¦‚æœä¸€ä¸ªä¼˜å…ˆçº§é«˜çš„çº¿ç¨‹ç­‰å¾…ä¸€ä¸ªä¼˜å…ˆçº§ä½çš„çº¿ç¨‹é‡Šæ”¾é”ä¼šå¯¼è‡´ä¼˜å…ˆçº§å€’ç½®ï¼Œå¼•èµ·æ€§èƒ½é—®é¢˜

```java
// ä¸å®‰å…¨åœ°ä¹°ç¥¨  
public class UnsafeBuyTicket {  
    public static void main(String[] args) {  
        BuyTicket station = new BuyTicket();  
  
        new Thread(station, "è‹¦é€¼çš„æˆ‘").start();  
        new Thread(station, "ç‰›é€¼çš„ä½ ").start();  
        new Thread(station, "å¯æ¶çš„é»„ç‰›").start();  
    }  
}  
  
class BuyTicket implements Runnable {  
  
    // ç¥¨  
    private int ticketNums = 10;  
    boolean flag = true;  
  
    @Override  
    public void run() {  
        // ä¹°ç¥¨  
        while (flag) {  
            buy();  
        }  
    }  
  
    private void buy() {  
        // åˆ¤æ–­æ˜¯å¦æœ‰ç¥¨  
        if (ticketNums <= 0) {  
            flag = false;  
            return;  
        }  
  
        // æ¨¡æ‹Ÿå»¶æ—¶  
        try {  
            Thread.sleep(100);  
        } catch (InterruptedException e) {  
            throw new RuntimeException(e);  
        }  
  
        // ä¹°ç¥¨  
        System.out.println(Thread.currentThread().getName() + "æ‹¿åˆ°" + ticketNums--);  
    }  
}
```

```java
// ä¸å®‰å…¨çš„å–é’±  
public class UnsafeBank {  
    public static void main(String[] args) {  
        Account account = new Account(100, "ç»“å©šåŸºé‡‘");  
  
        Drawing you = new Drawing(account, 50, "ä½ ");  
        Drawing girlFriend = new Drawing(account, 100, "å¥³æœ‹å‹");  
  
        you.start();  
        girlFriend.start();  
    }  
}  
  
// è´¦æˆ·  
class Account {  
    // ä½™é¢  
    int money;  
    // å¡å  
    String name;  
  
    public Account(int money, String name) {  
        this.money = money;  
        this.name = name;  
    }  
}  
  
// é“¶è¡Œï¼šæ¨¡æ‹Ÿå–é’±  
class Drawing extends Thread {  
    // è´¦æˆ·  
    Account account;  
    // å–äº†å¤šå°‘é’±  
    int drawingMoney;  
    // ç°åœ¨æ‰‹é‡Œæœ‰å¤šå°‘é’±  
    int nowMoney;  
  
    public Drawing(Account account, int drawingMoney, String name) {  
        super(name);  
        this.account = account;  
        this.drawingMoney = drawingMoney;  
    }  
  
    // å–é’±  
    @Override  
    public void run() {  
        // åˆ¤æ–­é“¶è¡Œæœ‰æ²¡æœ‰é’±  
        if (account.money - drawingMoney <= 0) {  
            System.out.println(Thread.currentThread().getName() + "é’±ä¸å¤Ÿï¼Œå–ä¸äº†");  
            return;  
        }  
  
        // æ¨¡æ‹Ÿå»¶æ—¶  
        try {  
            Thread.sleep(1000);  
        } catch (InterruptedException e) {  
            throw new RuntimeException(e);  
        }  
  
        // å¡å†…ä½™é¢ = ä½™é¢ - ä½ å–çš„é’±  
        account.money -= drawingMoney;  
        // ä½ æ‰‹é‡Œçš„é’±  
        nowMoney += drawingMoney;  
  
        System.out.println(account.name + "è´¦æˆ·ä½™é¢ä¸ºï¼š" + account.money);  
        // Thread.currentThread().getName() = this.getName()  
        System.out.println(this.getName() + "æ‰‹é‡Œçš„é’±ï¼š" + nowMoney);  
    }  
}
```

```java
import java.util.ArrayList;  
import java.util.List;  
  
// çº¿ç¨‹ä¸å®‰å…¨çš„é›†åˆ  
public class UnsafeList {  
    public static void main(String[] args) throws InterruptedException {  
        List<String> list = new ArrayList<String>();  
        for (int i = 0; i < 10000; i++) {  
            new Thread(() -> {  
                list.add(Thread.currentThread().getName());  
            }).start();  
        }  
        Thread.sleep(3000);  
        System.out.println(list.size());  
    }  
}
```

### åŒæ­¥æ–¹æ³•

- ç”±äºæˆ‘ä»¬å¯ä»¥é€šè¿‡ private å…³é”®å­—æ¥ä¿è¯æ•°æ®å¯¹è±¡åªèƒ½è¢«æ–¹æ³•è®¿é—®ï¼Œæ‰€ä»¥æˆ‘ä»¬åªéœ€è¦é’ˆå¯¹æ–¹æ³•æå‡ºä¸€å¥—æœºåˆ¶ï¼Œè¿™å¥—æœºåˆ¶å°±æ˜¯ synchronized å…³é”®å­—ï¼Œå®ƒåŒ…æ‹¬ä¸¤ç§ç”¨æ³•ï¼š**synchronized æ–¹æ³•** å’Œ **synchronized å—**
- åŒæ­¥æ–¹æ³•ï¼š`public synchronized void method(int argd) {}` 
- synchronizedæ–¹æ³•æ§åˆ¶â€œå¯¹è±¡â€çš„è®¿é—®ï¼Œæ¯ä¸ªå¯¹è±¡å¯¹åº”ä¸€æŠŠé”ï¼Œæ¯ä¸ªsynchronizedæ–¹æ³•éƒ½å¿…é¡»è·å¾—è°ƒç”¨æ–¹æ³•çš„å¯¹è±¡çš„é”æ‰èƒ½æ‰§è¡Œï¼Œå¦åˆ™çº¿ç¨‹å°±ä¼šé˜»å¡ï¼Œæ–¹æ³•ä¸€æ—¦æ‰§è¡Œï¼Œå°±ç‹¬å è¯¥é”ï¼Œç›´åˆ°è¯¥æ–¹æ³•è¿”å›æ‰é‡Šæ”¾é”ï¼Œåé¢è¢«é˜»å¡çš„çº¿ç¨‹æ‰èƒ½è·å¾—è¿™ä¸ªé”ï¼Œç»§ç»­æ‰§è¡Œã€‚
- ç¼ºé™·ï¼š**è‹¥å°†ä¸€ä¸ªå¤§çš„æ–¹æ³•å£°æ˜ä¸ºsynchronizedå°†ä¼šå½±å“æ•ˆç‡** 

```java
// ä¸å®‰å…¨åœ°ä¹°ç¥¨  
public class UnsafeBuyTicket {  
    public static void main(String[] args) {  
        BuyTicket station = new BuyTicket();  
  
        new Thread(station, "è‹¦é€¼çš„æˆ‘").start();  
        new Thread(station, "ç‰›é€¼çš„ä½ ").start();  
        new Thread(station, "å¯æ¶çš„é»„ç‰›").start();  
    }  
}  
  
class BuyTicket implements Runnable {  
  
    // ç¥¨  
    private int ticketNums = 10;  
    boolean flag = true;  
  
    @Override  
    public void run() {  
        // ä¹°ç¥¨  
        while (flag) {  
            buy();  
        }  
    }  
  
    private synchronized void buy() {  
        // åˆ¤æ–­æ˜¯å¦æœ‰ç¥¨  
        if (ticketNums <= 0) {  
            flag = false;  
            return;  
        }  
  
        // æ¨¡æ‹Ÿå»¶æ—¶  
        try {  
            Thread.sleep(100);  
        } catch (InterruptedException e) {  
            throw new RuntimeException(e);  
        }  
  
        // ä¹°ç¥¨  
        System.out.println(Thread.currentThread().getName() + "æ‹¿åˆ°" + ticketNums--);  
    }  
}
```

#### åŒæ­¥æ–¹æ³•å¼Šç«¯

- æ–¹æ³•é‡Œé¢éœ€è¦ä¿®æ”¹çš„å†…å®¹æ‰éœ€è¦é”ï¼Œé”çš„å¤ªå¤šï¼Œæµªè´¹èµ„æº

### åŒæ­¥å—

- åŒæ­¥å—ï¼š`synchronized (Obj) {}` 
- Obj ç§°ä¹‹ä¸º**åŒæ­¥ç›‘è§†å™¨** 
	- Obj å¯ä»¥æ˜¯ä»»ä½•å¯¹è±¡ï¼Œä½†æ˜¯æ¨èä½¿ç”¨å…±äº«èµ„æºä½œä¸ºåŒæ­¥ç›‘è§†å™¨
	- åŒæ­¥æ–¹æ³•ä¸­æ— éœ€æŒ‡å®šåŒæ­¥ç›‘è§†å™¨ï¼Œå› ä¸ºåŒæ­¥æ–¹æ³•çš„åŒæ­¥ç›‘è§†å™¨å°±æ˜¯thisï¼Œå°±æ˜¯è¿™ä¸ªå¯¹è±¡æœ¬èº«ï¼Œæˆ–æ˜¯ class
- åŒæ­¥ç›‘è§†å™¨çš„æ‰§è¡Œè¿‡ç¨‹
	1. ç¬¬ä¸€ä¸ªçº¿ç¨‹è®¿é—®ï¼Œé”å®šåŒæ­¥ç›‘è§†å™¨ï¼Œæ‰§è¡Œå…¶ä¸­ä»£ç 
	2. ç¬¬äºŒä¸ªçº¿ç¨‹è®¿é—®ï¼Œå‘ç°åŒæ­¥ç›‘è§†å™¨è¢«é”å®šï¼Œæ— æ³•è®¿é—®
	3. ç¬¬ä¸€ä¸ªçº¿ç¨‹è®¿é—®å®Œæ¯•ï¼Œè§£é”åŒæ­¥ç›‘è§†å™¨
	4. ç¬¬äºŒä¸ªçº¿ç¨‹è®¿é—®ï¼Œå‘ç°åŒæ­¥ç›‘è§†å™¨æ²¡æœ‰é”ï¼Œç„¶åé”å®šå¹¶è®¿é—®
	
```java
// ä¸å®‰å…¨çš„å–é’±  
public class UnsafeBank {  
    public static void main(String[] args) {  
        Account account = new Account(100, "ç»“å©šåŸºé‡‘");  
  
        Drawing you = new Drawing(account, 50, "ä½ ");  
        Drawing girlFriend = new Drawing(account, 100, "å¥³æœ‹å‹");  
  
        you.start();  
        girlFriend.start();  
    }  
}  
  
// è´¦æˆ·  
class Account {  
    // ä½™é¢  
    int money;  
    // å¡å  
    String name;  
  
    public Account(int money, String name) {  
        this.money = money;  
        this.name = name;  
    }  
}  
  
// é“¶è¡Œï¼šæ¨¡æ‹Ÿå–é’±  
class Drawing extends Thread {  
    // è´¦æˆ·  
    Account account;  
    // å–äº†å¤šå°‘é’±  
    int drawingMoney;  
    // ç°åœ¨æ‰‹é‡Œæœ‰å¤šå°‘é’±  
    int nowMoney;  
  
    public Drawing(Account account, int drawingMoney, String name) {  
        super(name);  
        this.account = account;  
        this.drawingMoney = drawingMoney;  
    }  
  
    // å–é’±  
    @Override  
    public void run() {  
        synchronized (account) {  
            // åˆ¤æ–­é“¶è¡Œæœ‰æ²¡æœ‰é’±  
            if (account.money - drawingMoney <= 0) {  
                System.out.println(Thread.currentThread().getName() + "é’±ä¸å¤Ÿï¼Œå–ä¸äº†");  
                return;  
            }  
  
            // æ¨¡æ‹Ÿå»¶æ—¶  
            try {  
                Thread.sleep(1000);  
            } catch (InterruptedException e) {  
                throw new RuntimeException(e);  
            }  
  
            // å¡å†…ä½™é¢ = ä½™é¢ - ä½ å–çš„é’±  
            account.money -= drawingMoney;  
            // ä½ æ‰‹é‡Œçš„é’±  
            nowMoney += drawingMoney;  
  
            System.out.println(account.name + "è´¦æˆ·ä½™é¢ä¸ºï¼š" + account.money);  
            // Thread.currentThread().getName() = this.getName()  
            System.out.println(this.getName() + "æ‰‹é‡Œçš„é’±ï¼š" + nowMoney);  
        }  
    }  
}
```

```java
import java.util.ArrayList;  
import java.util.List;  
  
// çº¿ç¨‹ä¸å®‰å…¨çš„é›†åˆ  
public class UnsafeList {  
    public static void main(String[] args) throws InterruptedException {  
        List<String> list = new ArrayList<String>();  
        for (int i = 0; i < 10000; i++) {  
            new Thread(() -> {  
                synchronized (list) {  
                    list.add(Thread.currentThread().getName());  
                }  
            }).start();  
        }  
        Thread.sleep(3000);  
        System.out.println(list.size());  
    }  
}
```

### CopyOnWriteArrayList

```java
// æµ‹è¯•JUCå®‰å…¨ç±»å‹çš„é›†åˆ  
public class TestJUC {  
    public static void main(String[] args) {  
        CopyOnWriteArrayList<String> list = new CopyOnWriteArrayList<String>();  
        for (int i = 0; i < 10000; i++) {  
            new Thread(() -> {  
                list.add(Thread.currentThread().getName());  
            }).start();  
        }  
        try {  
            Thread.sleep(3000);  
        } catch (InterruptedException e) {  
            throw new RuntimeException(e);  
        }  
        System.out.println(list.size());  
    }  
}
```

### æ­»é”

- å¤šä¸ªçº¿ç¨‹å„è‡ªå æœ‰ä¸€äº›å…±äº«èµ„æºï¼Œå¹¶ä¸”äº’ç›¸ç­‰å¾…å…¶ä»–çº¿ç¨‹å æœ‰çš„èµ„æºæ‰èƒ½è¿è¡Œï¼Œè€Œå¯¼è‡´ä¸¤ä¸ªæˆ–è€…å¤šä¸ªçº¿ç¨‹éƒ½åœ¨ç­‰å¾…å¯¹æ–¹é‡Šæ”¾èµ„æºï¼Œéƒ½åœæ­¢æ‰§è¡Œçš„æƒ…å½¢ã€‚æŸä¸€ä¸ªåŒæ­¥å—åŒæ—¶æ‹¥æœ‰â€œ**ä¸¤ä¸ªä»¥ä¸Šå¯¹è±¡çš„é”**â€æ—¶ï¼Œå°±å¯èƒ½ä¼šå‘ç”Ÿâ€œæ­»é”â€çš„é—®é¢˜ã€‚

```java
// æ­»é”ï¼šå¤šä¸ªçº¿ç¨‹äº’ç›¸æŠ±ç€å¯¹æ–¹éœ€è¦çš„èµ„æºï¼Œç„¶åå½¢æˆåƒµæŒã€‚  
public class DeadLock {  
    public static void main(String[] args) {  
        Makeup g1 = new Makeup(0, "ç°å§‘å¨˜");  
        Makeup g2 = new Makeup(1, "ç™½é›ªå…¬ä¸»");  
  
        g1.start();  
        g2.start();  
    }  
}  
  
// å£çº¢  
class Lipstick {  
  
}  
  
// é•œå­  
class Mirror {  
  
}  
  
class Makeup extends Thread {  
  
    // éœ€è¦çš„èµ„æºåªæœ‰ä¸€ä»½ï¼Œç”¨staticæ¥ä¿è¯åªæœ‰ä¸€ä»½  
    static Lipstick lipstick = new Lipstick();  
    static Mirror mirror = new Mirror();  
  
    int choice;  
    String girlName;  
  
    Makeup(int choice, String girlName) {  
        this.choice = choice;  
        this.girlName = girlName;  
    }  
  
    @Override  
    public void run() {  
        // åŒ–å¦†  
        try {  
            makeup();  
        } catch (InterruptedException e) {  
            throw new RuntimeException(e);  
        }  
    }  
  
    // åŒ–å¦†ï¼Œäº’ç›¸æŒæœ‰å¯¹æ–¹çš„é”ï¼Œå°±æ˜¯éœ€è¦æ‹¿åˆ°å¯¹æ–¹çš„èµ„æº  
    private void makeup() throws InterruptedException {  
        if (choice == 0) {  
            // è·å¾—å£çº¢çš„é”  
            synchronized (lipstick) {  
                System.out.println(this.girlName + "è·å¾—å£çº¢çš„é”");  
                Thread.sleep(1000);  
  
                // ä¸€ç§’é’Ÿåæƒ³è·å¾—é•œå­  
                synchronized (mirror) {  
                    System.out.println(this.girlName + "è·å¾—é•œå­çš„é”");  
                }  
            }  
        } else {  
            // è·å¾—é•œå­çš„é”  
            synchronized (mirror) {  
                System.out.println(this.girlName + "è·å¾—é•œå­çš„é”");  
                Thread.sleep(2000);  
  
                // ä¸€ç§’é’Ÿåæƒ³è·å¾—å£çº¢  
                synchronized (lipstick) {  
                    System.out.println(this.girlName + "è·å¾—å£çº¢çš„é”");  
                }  
            }  
        }  
    }  
}
```

![](https://i0.hdslb.com/bfs/album/6115192b73fcae2e5f759db16b1f7b8e4c6a4546.png)

#### æ­»é”é¿å…æ–¹æ³•

- äº§ç”Ÿæ­»é”çš„å››ä¸ªå¿…è¦æ¡ä»¶
	1. **äº’æ–¥æ¡ä»¶**ï¼šä¸€ä¸ªèµ„æºä¸€æ¬¡åªèƒ½è¢«ä¸€ä¸ªè¿›ç¨‹ä½¿ç”¨
	2. **è¯·æ±‚ä¸ä¿æŒæ¡ä»¶**ï¼šä¸€ä¸ªè¿›ç¨‹å› è¯·æ±‚èµ„æºè€Œé˜»å¡æ—¶ï¼Œå¯¹å·²è·å¾—çš„èµ„æºä¿æŒä¸æ”¾
	3. **ä¸å‰¥å¤ºæ¡ä»¶**ï¼šè¿›ç¨‹å·²è·å¾—çš„èµ„æºï¼Œåœ¨æœªä½¿ç”¨å®Œä¹‹å‰ï¼Œä¸èƒ½å¼ºè¡Œå‰¥å¤º
	4. **å¾ªç¯ç­‰å¾…æ¡ä»¶**ï¼šè‹¥å¹²è¿›ç¨‹ä¹‹é—´å½¢æˆä¸€ç§å¤´å°¾ç›¸æ¥çš„å¾ªç¯ç­‰å¾…èµ„æºå…³ç³»
- **åªéœ€æƒ³åŠæ³•ç ´åä¸Šè¿°å››ä¸ªæ¡ä»¶ä¸­çš„ä»»æ„ä¸€ä¸ªæˆ–å¤šä¸ªæ¡ä»¶å°±å¯ä»¥é¿å…æ­»é”** 

```java
// åŒ–å¦†ï¼Œäº’ç›¸æŒæœ‰å¯¹æ–¹çš„é”ï¼Œå°±æ˜¯éœ€è¦æ‹¿åˆ°å¯¹æ–¹çš„èµ„æº  
private void makeup() throws InterruptedException {  
    if (choice == 0) {  
        // è·å¾—å£çº¢çš„é”  
        synchronized (lipstick) {  
            System.out.println(this.girlName + "è·å¾—å£çº¢çš„é”");  
            Thread.sleep(1000);  
        }  
        // ä¸€ç§’é’Ÿåæƒ³è·å¾—é•œå­  
        synchronized (mirror) {  
            System.out.println(this.girlName + "è·å¾—é•œå­çš„é”");  
        }  
    } else {  
        // è·å¾—é•œå­çš„é”  
        synchronized (mirror) {  
            System.out.println(this.girlName + "è·å¾—é•œå­çš„é”");  
            Thread.sleep(2000);  
        }  
        // ä¸€ç§’é’Ÿåæƒ³è·å¾—å£çº¢  
        synchronized (lipstick) {  
            System.out.println(this.girlName + "è·å¾—å£çº¢çš„é”");  
        }  
    }  
}
```

![](https://i0.hdslb.com/bfs/album/b5807d6050d4c960e74872b796b7c5d27d56419c.png)

### Lockï¼ˆé”ï¼‰

- ä»JDK5.0å¼€å§‹ï¼ŒJavaæä¾›äº†æ›´å¼ºå¤§çš„çº¿ç¨‹åŒæ­¥æœºåˆ¶â€”â€”é€šè¿‡æ˜¾å¼å®šä¹‰åŒæ­¥é”å¯¹è±¡æ¥å®ç°åŒæ­¥ã€‚åŒæ­¥é”ä½¿ç”¨Lockå¯¹è±¡å……å½“ã€‚
- java.util.concurrent.locks.Lock æ¥å£æ˜¯æ§åˆ¶å¤šä¸ªçº¿ç¨‹å¯¹å…±äº«èµ„æºè¿›è¡Œè®¿é—®çš„å·¥å…·ã€‚é”æä¾›äº†å¯¹å…±äº«èµ„æºçš„ç‹¬å è®¿é—®ï¼Œæ¯æ¬¡åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹å¯¹Lockå¯¹è±¡åŠ é”ï¼Œçº¿ç¨‹å¼€å§‹è®¿é—®å…±äº«èµ„æºä¹‹å‰åº”å…ˆè·å¾—Lockå¯¹è±¡ã€‚
- ReentrantLock[^1] ç±»å®ç°äº† Lockï¼Œå®ƒæ‹¥æœ‰ä¸ synchronized ç›¸åŒçš„å¹¶å‘æ€§å’Œå†…å­˜è¯­ä¹‰ï¼Œåœ¨å®ç°çº¿ç¨‹å®‰å…¨çš„æ§åˆ¶ä¸­ï¼Œæ¯”è¾ƒå¸¸ç”¨çš„æ˜¯ReentrantLockï¼Œå¯ä»¥æ˜¾å¼åŠ é”ã€é‡Šæ”¾é”ã€‚

```java
import java.util.concurrent.locks.ReentrantLock;  
  
public class TestLock {  
    public static void main(String[] args) {  
        TestLock2 testLock2 = new TestLock2();  
  
        new Thread(testLock2).start();  
        new Thread(testLock2).start();  
        new Thread(testLock2).start();  
    }  
}  
  
class TestLock2 implements Runnable {  
  
    int ticketNums = 10;  
  
    // å®šä¹‰Locké”  
    private final ReentrantLock lock = new ReentrantLock();  
  
    @Override  
    public void run() {  
        while (true) {  
            try {  
                // åŠ é”  
                lock.lock();  
  
                if (ticketNums > 0) {  
                    try {  
                        Thread.sleep(1000);  
                    } catch (InterruptedException e) {  
                        throw new RuntimeException(e);  
                    }  
                    System.out.println(ticketNums--);  
                } else {  
                    break;  
                }  
            } finally {  
                // è§£é”  
                lock.unlock();  
            }  
        }  
    }  
}
```

[^1]:å¯é‡å…¥é”

#### synchronized ä¸ Lock å¯¹æ¯”

- Lock æ—¶æ˜¾å¼é”ï¼ˆæ‰‹åŠ¨å¼€å¯å’Œå…³é—­é”ï¼‰ï¼›synchronized æ˜¯éšå¼é”ï¼Œå‡ºäº†ä½œç”¨åŸŸè‡ªåŠ¨é‡Šæ”¾
- Lock åªæœ‰ä»£ç å—é”ï¼›synchronized æœ‰ä»£ç å—é”å’Œæ–¹æ³•é”
- ä½¿ç”¨ Lock é”ï¼ŒJVM å°†èŠ±è´¹å°‘çš„æ—¶é—´æ¥è°ƒåº¦çº¿ç¨‹ï¼Œæ€§èƒ½æ›´å¥½ï¼Œå¹¶ä¸”å…·æœ‰æ›´å¥½çš„æ‰©å±•æ€§ï¼ˆæä¾›æ›´å¤šçš„å­ç±»ï¼‰
- ä¼˜å…ˆä½¿ç”¨é¡ºåºï¼š
	- Lock > åŒæ­¥ä»£ç å—ï¼ˆå·²ç»è¿›å…¥äº†æ–¹æ³•ä½“ï¼Œåˆ†é…äº†ç›¸åº”çš„èµ„æºï¼‰> åŒæ­¥æ–¹æ³•ï¼ˆåœ¨æ–¹æ³•ä½“ä¹‹å¤–ï¼‰

## çº¿ç¨‹åä½œ

ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å¼

### çº¿ç¨‹é€šä¿¡

- åº”ç”¨åœºæ™¯ï¼šç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…é—®é¢˜
	- å‡è®¾ä»“åº“ä¸­åªèƒ½å­˜æ”¾ä¸€ä»¶äº§å“ï¼Œç”Ÿäº§è€…å°†ç”Ÿäº§å‡ºæ¥çš„äº§å“æ”¾å…¥ä»“åº“ï¼Œæ¶ˆè´¹è€…å°†ä»“åº“ä¸­äº§å“å–èµ°æ¶ˆè´¹
	- å¦‚æœä»“åº“ä¸­æ²¡æœ‰äº§å“ï¼Œåˆ™ç”Ÿäº§è€…å°†äº§å“æ”¾å…¥ä»“åº“ï¼Œå¦åˆ™åœæ­¢ç”Ÿäº§å¹¶ç­‰å¾…ï¼Œç›´åˆ°ä»“åº“ä¸­çš„äº§å“è¢«æ¶ˆè´¹è€…å–èµ°ä¸ºæ­¢
	- å¦‚æœä»“åº“ä¸­æœ‰äº§å“ï¼Œåˆ™æ¶ˆè´¹è€…å¯ä»¥å°†äº§å“å–èµ°æ¶ˆè´¹ï¼Œå¦åˆ™åœæ­¢æ¶ˆè´¹å¹¶ç­‰å¾…ï¼Œç›´åˆ°ä»“åº“ä¸­å†æ¬¡æ”¾å…¥äº§å“ä¸ºæ­¢
- åˆ†æï¼š
	- è¿™æ˜¯ä¸€ä¸ªçº¿ç¨‹åŒæ­¥é—®é¢˜ï¼Œ**ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…å…±äº«åŒä¸€ä¸ªèµ„æºï¼Œå¹¶ä¸”ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ä¹‹é—´ç›¸äº’ä¾èµ–ï¼Œäº’ä¸ºæ¡ä»¶**
	- å¯¹äºç”Ÿäº§è€…ï¼Œæ²¡æœ‰ç”Ÿäº§äº§å“ä¹‹å‰ï¼Œè¦é€šçŸ¥æ¶ˆè´¹è€…ç­‰å¾…ï¼Œè€Œç”Ÿäº§äº†äº§å“ä¹‹åï¼Œåˆéœ€è¦é©¬ä¸Šé€šçŸ¥æ¶ˆè´¹è€…æ¶ˆè´¹
	- å¯¹äºæ¶ˆè´¹è€…ï¼Œåœ¨æ¶ˆè´¹ä¹‹åï¼Œè¦é€šçŸ¥ç”Ÿäº§è€…å·²ç»ç»“æŸæ¶ˆè´¹ï¼Œéœ€è¦ç”Ÿäº§æ–°çš„äº§å“ä»¥ä¾›æ¶ˆè´¹
	- åœ¨ç”Ÿäº§è€…æ¶ˆè´¹è€…é—®é¢˜ä¸­ï¼Œä»…æœ‰ synchronized æ˜¯ä¸å¤Ÿçš„
		- synchronized å¯é˜»æ­¢å¹¶å‘æ›´æ–°åŒä¸€ä¸ªå…±äº«èµ„æºï¼Œå®ç°äº†åŒæ­¥
		- synchronized ä¸èƒ½ç”¨æ¥å®ç°ä¸åŒçº¿ç¨‹ä¹‹é—´çš„æ¶ˆæ¯ä¼ é€’ï¼ˆé€šä¿¡ï¼‰
- Javaæä¾›äº†å‡ ä¸ªæ–¹æ³•è§£å†³çº¿ç¨‹ä¹‹é—´çš„é€šä¿¡é—®é¢˜

|       æ–¹æ³•å       |                                ä½œç”¨                                |
|:------------------:|:------------------------------------------------------------------:|
|       wait()       |     è¡¨ç¤ºçº¿ç¨‹ä¸€ç›´ç­‰å¾…ï¼Œç›´åˆ°å…¶ä»–çº¿ç¨‹é€šçŸ¥ï¼Œä¸sleepä¸åŒï¼Œä¼šé‡Šæ”¾é”      |
| wait(long timeout) |                          æŒ‡å®šç­‰å¾…çš„æ¯«ç§’æ•°                          |
|      notify()      |                     å”¤é†’ä¸€ä¸ªå¤„äºç­‰å¾…çŠ¶æ€çš„çº¿ç¨‹                     |
|    notifyAll()     | å”¤é†’åŒä¸€ä¸ªå¯¹è±¡ä¸Šæ‰€æœ‰è°ƒç”¨wait()æ–¹æ³•çš„çº¿ç¨‹ï¼Œä¼˜å…ˆçº§åˆ«é«˜çš„çº¿ç¨‹ä¼˜å…ˆè°ƒåº¦ | 
>âš ï¸æ³¨æ„ï¼š
>å‡æ˜¯Objectç±»çš„æ–¹æ³•ï¼Œéƒ½åªèƒ½åœ¨åŒæ­¥æ–¹æ³•æˆ–è€…åŒæ­¥ä»£ç å—ä¸­ä½¿ç”¨ï¼Œå¦åˆ™ä¼šæŠ›å‡ºå¼‚å¸¸ IllegalMonitorStateException

### è§£å†³æ–¹å¼1

å¹¶å‘åä½œæ¨¡å‹â€œç”Ÿäº§è€…/æ¶ˆè´¹è€…æ¨¡å¼â€---> ç®¡ç¨‹æ³•

- ç”Ÿäº§è€…ï¼šè´Ÿè´£ç”Ÿäº§æ•°æ®çš„æ¨¡å—ï¼ˆå¯èƒ½æ˜¯æ–¹æ³•ã€å¯¹è±¡ã€çº¿ç¨‹ã€è¿›ç¨‹ï¼‰
- æ¶ˆè´¹è€…ï¼šè´Ÿè´£å¤„ç†æ•°æ®çš„æ¨¡å—ï¼ˆå¯èƒ½æ˜¯æ–¹æ³•ã€å¯¹è±¡ã€çº¿ç¨‹ã€è¿›ç¨‹ï¼‰
- ç¼“å†²åŒºï¼šæ¶ˆè´¹è€…ä¸èƒ½ç›´æ¥ä½¿ç”¨ç”Ÿäº§è€…çš„æ•°æ®ï¼Œå®ƒä»¬ä¹‹é—´æœ‰ä¸ªâ€œç¼“å†²åŒºâ€œ
- **ç”Ÿäº§è€…å°†ç”Ÿäº§å¥½çš„æ•°æ®æ”¾å…¥ç¼“å†²åŒºï¼Œæ¶ˆè´¹è€…ä»ç¼“å†²åŒºæ‹¿æ•°æ®** 

```java
public class TestPC {  
    public static void main(String[] args) {  
        SynContainer container = new SynContainer();  
  
        new Producer(container).start();  
        new Consumer(container).start();  
    }  
}  
  
// ç”Ÿäº§è€…  
class Producer extends Thread {  
    SynContainer container;  
  
    public Producer(SynContainer container) {  
        this.container = container;  
    }  
  
    // ç”Ÿäº§  
    @Override  
    public void run() {  
        for (int i = 0; i < 100; i++) {  
            container.push(new Chicken(i));  
            System.out.println("ç”Ÿäº§äº†" + i + "åªé¸¡");  
        }  
    }  
}  
  
// æ¶ˆè´¹è€…  
class Consumer extends Thread {  
    SynContainer container;  
  
    public Consumer(SynContainer container) {  
        this.container = container;  
    }  
  
    // æ¶ˆè´¹  
    @Override  
    public void run() {  
        for (int i = 0; i < 100; i++) {  
            System.out.println("æ¶ˆè´¹äº†-->" + container.pop().id + "åªé¸¡");  
        }  
    }  
}  
  
// äº§å“  
class Chicken {  
    // äº§å“ç¼–å·  
    int id;  
  
    public Chicken(int id) {  
        this.id = id;  
    }  
}  
  
// ç¼“å†²åŒº  
class SynContainer {  
    // å®¹å™¨å¤§å°  
    Chicken[] chickens = new Chicken[10];  
  
    // å®¹å™¨è®¡æ•°å™¨  
    int count = 0;  
  
    // ç”Ÿäº§è€…æ”¾å…¥äº§å“  
    public synchronized void push(Chicken chicken) {  
        // å¦‚æœå®¹å™¨æ»¡äº†ï¼Œå°±éœ€è¦ç­‰å¾…æ¶ˆè´¹è€…æ¶ˆè´¹  
        if (count == chickens.length) {  
            // é€šçŸ¥æ¶ˆè´¹è€…æ¶ˆè´¹ï¼Œç”Ÿäº§è€…ç­‰å¾…  
            try {  
                this.wait();  
            } catch (InterruptedException e) {  
                throw new RuntimeException(e);  
            }  
        }  
  
        // å¦‚æœæ²¡æœ‰æ»¡ï¼Œå°±éœ€è¦ç”Ÿäº§è€…æ”¾å…¥äº§å“  
        chickens[count] = chicken;  
        count++;  
  
        // å¯ä»¥é€šçŸ¥æ¶ˆè´¹è€…æ¶ˆè´¹äº†  
        this.notifyAll();  
    }  
  
    // æ¶ˆè´¹è€…æ¶ˆè´¹äº§å“  
    public synchronized Chicken pop() {  
        // åˆ¤æ–­èƒ½å¦æ¶ˆè´¹  
        if (count == 0) {  
            // ç­‰å¾…ç”Ÿäº§è€…ç”Ÿäº§ï¼Œæ¶ˆè´¹è€…ç­‰å¾…  
            try {  
                this.wait();  
            } catch (InterruptedException e) {  
                throw new RuntimeException(e);  
            }  
        }  
  
        // å¦‚æœå¯ä»¥æ¶ˆè´¹  
        count--;  
        Chicken chicken = chickens[count];  
  
        // åƒå®Œäº†ï¼Œé€šçŸ¥ç”Ÿäº§è€…ç”Ÿäº§  
        this.notifyAll();  
  
        return chicken;  
    }  
}
```

### è§£å†³æ–¹å¼2

- å¹¶å‘åä½œæ¨¡å‹â€œç”Ÿäº§è€…/æ¶ˆè´¹è€…æ¨¡å¼â€---> ä¿¡å·ç¯æ³•

```java
public class TestPC2 {  
    public static void main(String[] args) {  
        TV tv = new TV();  
  
        new Player(tv).start();  
        new Watcher(tv).start();  
    }  
}  
  
// ç”Ÿäº§è€… --> æ¼”å‘˜  
class Player extends Thread {  
    TV tv;  
  
    public Player(TV tv) {  
        this.tv = tv;  
    }  
  
    @Override  
    public void run() {  
        for (int i = 0; i < 20; i++) {  
            if (i % 2 == 0) {  
                this.tv.play("å¿«ä¹å¤§æœ¬è¥");  
            } else {  
                this.tv.play("æŠ–éŸ³ï¼šè®°å½•ç¾å¥½ç”Ÿæ´»");  
            }  
        }  
    }  
}  
  
// æ¶ˆè´¹è€… --> è§‚ä¼—  
class Watcher extends Thread {  
    TV tv;  
  
    public Watcher(TV tv) {  
        this.tv = tv;  
    }  
  
    @Override  
    public void run() {  
        for (int i = 0; i < 20; i++) {  
            tv.watch();  
        }  
    }  
}  
  
// äº§å“ --> èŠ‚ç›®  
class TV {  
  
    // è¡¨æ¼”çš„èŠ‚ç›®  
    String voice;  
  
    boolean flag = true;  
  
    // è¡¨æ¼”  
    public synchronized void play(String voice) {  
        System.out.println("æ¼”å‘˜è¡¨æ¼”äº†" + voice);  
  
        if (!flag) {  
            try {  
                this.wait();  
            } catch (InterruptedException e) {  
                throw new RuntimeException(e);  
            }  
        }  
  
        // é€šçŸ¥è§‚ä¼—è§‚çœ‹  
        this.notifyAll();  
        this.voice = voice;  
        this.flag = !this.flag;  
    }  
  
    // è§‚çœ‹  
    public synchronized void watch() {  
        if (flag) {  
            try {  
                this.wait();  
            } catch (InterruptedException e) {  
                throw new RuntimeException(e);  
            }  
        }  
        System.out.println("è§‚ä¼—è§‚çœ‹äº†ï¼š" + voice);  
  
        // è§‚çœ‹å®Œæ¯•é€šçŸ¥æ¼”å‘˜è¡¨æ¼”  
        this.notifyAll();  
        this.flag = !this.flag;  
    }  
}
```

### çº¿ç¨‹æ± 

- èƒŒæ™¯ï¼šç»å¸¸åˆ›å»ºå’Œé”€æ¯ã€ä½¿ç”¨é‡ç‰¹åˆ«å¤§çš„èµ„æºï¼Œæ¯”å¦‚å¹¶å‘æƒ…å†µä¸‹çš„çº¿ç¨‹ï¼Œå¯¹æ€§èƒ½å½±å“å¾ˆå¤§
- æ€è·¯ï¼šæå‰åˆ›å»ºå¥½å¤šä¸ªçº¿ç¨‹ï¼Œæ”¾å…¥çº¿ç¨‹æ± ä¸­ï¼Œä½¿ç”¨æ—¶ç›´æ¥è·å–ï¼Œä½¿ç”¨å®Œæ”¾å›æ± ä¸­ã€‚å¯ä»¥é¿å…é¢‘ç¹åˆ›å»ºé”€æ¯ã€å®ç°é‡å¤åˆ©ç”¨ã€‚
- å¥½å¤„ï¼š
	- æé«˜å“åº”é€Ÿåº¦ï¼ˆå‡å°‘äº†åˆ›å»ºæ–°çº¿ç¨‹çš„æ—¶é—´ï¼‰
	- é™ä½èµ„æºæ¶ˆè€—ï¼ˆé‡å¤åˆ©ç”¨çº¿ç¨‹æ± ä¸­çº¿ç¨‹ï¼Œä¸éœ€è¦æ¯æ¬¡éƒ½åˆ›å»ºï¼‰
	- ä¾¿äºçº¿ç¨‹ç®¡ç†
		- `corePoolSize`ï¼šæ ¸å¿ƒæ± çš„å¤§å°
		- `maximumPoolSize`ï¼šæœ€å¤§çº¿ç¨‹æ•°
		- `keepAliveTime`ï¼šçº¿ç¨‹æ²¡æœ‰ä»»åŠ¡æ—¶æœ€å¤šä¿æŒå¤šé•¿æ—¶é—´åä¼šç»ˆæ­¢

#### ä½¿ç”¨çº¿ç¨‹æ± 

- JDK5.0èµ·æä¾›äº†çº¿ç¨‹æ± ç›¸å…³APIï¼šExecutorService å’Œ Executors
- ExecutorServiceï¼šçœŸæ­£çš„çº¿ç¨‹æ± æ¥å£ã€‚å¸¸è§å­ç±»ï¼šThreadPoolExecutor
	- `void execute(Runnable command)`ï¼šæ‰§è¡Œä»»åŠ¡/å‘½ä»¤ï¼Œæ²¡æœ‰è¿”å›å€¼ï¼Œä¸€èˆ¬ç”¨æ¥æ‰§è¡ŒRunnable
	- `<T> Future<T> submit(Callable<T> task)`ï¼šæ‰§è¡Œä»»åŠ¡ï¼Œæœ‰è¿”å›å€¼ï¼Œä¸€èˆ¬ç”¨æ¥æ‰§è¡ŒCallable
	- `void shutdown()`ï¼šå…³é—­è¿æ¥æ± 
- Executorsï¼šå·¥å…·ç±»ã€çº¿ç¨‹æ± çš„å·¥å‚ç±»ï¼Œç”¨äºåˆ›å»ºå¹¶è¿”å›ä¸åŒç±»å‹çš„çº¿ç¨‹æ± 

```java
import org.apache.commons.io.FileUtils;  
  
import java.io.IOException;  
import java.util.concurrent.*;  
  
public class TestCallable implements Callable<Boolean> {  
  
    private String url; // ç½‘ç»œå›¾ç‰‡åœ°å€  
    private String name; // ä¿å­˜çš„æ–‡ä»¶å  
  
    public static void main(String[] args) throws ExecutionException, InterruptedException {  
        TestCallable t1 = new TestCallable("https://blog.kuangstudy.con/usr/themes/handsome/usr/img/sj/2.jpg", "1.jpg");  
        TestCallable t2 = new TestCallable("https://blog.kuangstudy.con/usr/themes/handsome/usr/img/sj/2.jpg", "2.jpg");  
        TestCallable t3 = new TestCallable("https://blog.kuangstudy.con/usr/themes/handsome/usr/img/sj/2.jpg", "3.jpg");  
  
        // åˆ›å»ºæ‰§è¡ŒæœåŠ¡  
        ExecutorService ser = Executors.newFixedThreadPool(3);  
  
        // æäº¤æ‰§è¡Œ  
        Future<Boolean> result1 = ser.submit(t1);  
        Future<Boolean> result2 = ser.submit(t2);  
        Future<Boolean> result3 = ser.submit(t3);  
  
        // è·å–ç»“æœ  
        boolean r1 = result1.get();  
        boolean r2 = result2.get();  
        boolean r3 = result3.get();  
  
        System.out.println(r1);  
        System.out.println(r2);  
        System.out.println(r3);  
  
        // å…³é—­æœåŠ¡  
        ser.shutdownNow();  
    }  
  
    public TestCallable(String url, String name) {  
        this.url = url;  
        this.name = name;  
    }  
  
    // ä¸‹è½½å›¾ç‰‡çº¿ç¨‹çš„æ‰§è¡Œä½“  
    @Override  
    public Boolean call() throws Exception {  
        WenDownloader wenDownloader = new WenDownloader();  
        wenDownloader.downloader(url, name);  
        System.out.println("ä¸‹è½½äº†æ–‡ä»¶åä¸ºï¼š" + name);  
        return true;  
    }  
}  
  
// ä¸‹è½½å™¨  
class WenDownloader {  
    // ä¸‹è½½æ–¹æ³•  
    public void downloader() {  
        try {  
            FileUtils.copyURLToFile(new URL(url), new File(name));  
        } catch (IOException e) {  
            e.printStackTrace();  
            System.out.println("IOå¼‚å¸¸ï¼Œdownloaderæ–¹æ³•å‡ºç°é—®é¢˜");  
        }  
    }  
}
```

```java
import java.util.concurrent.ExecutorService;  
import java.util.concurrent.Executors;  
  
public class TestPool {  
    public static void main(String[] args) {  
        // åˆ›å»ºçº¿ç¨‹æ±   
        ExecutorService executorService = Executors.newFixedThreadPool(10);  
  
        executorService.execute(new MyThread());  
        executorService.execute(new MyThread());  
        executorService.execute(new MyThread());  
        executorService.execute(new MyThread());  
  
        // å…³é—­è¿æ¥  
        executorService.shutdown();  
    }  
}  
  
class MyThread implements Runnable {  
  
    @Override  
    public void run() {  
        System.out.println(Thread.currentThread().getName());  
    }  
}
```
